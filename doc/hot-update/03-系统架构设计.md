# 系统架构设计

## 目录

1. [整体架构](#1-整体架构)
2. [客户端架构](#2-客户端架构)
3. [服务端架构](#3-服务端架构)
4. [通信协议](#4-通信协议)
5. [数据流设计](#5-数据流设计)

---

## 1. 整体架构

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                     IMPos2 热更新系统架构                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          管理后台                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ 版本管理 │  │ 灰度配置 │  │ 设备管理 │  │ 统计监控 │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/HTTPS
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                          服务端                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                      Nginx (反向代理)                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                   │
│         ┌────────────────────┼────────────────────┐            │
│         ↓                    ↓                    ↓            │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │
│  │  API 服务   │    │  推送服务   │    │  文件服务   │       │
│  │  (Express)  │    │ (Socket.IO) │    │   (Nginx)   │       │
│  └─────────────┘    └─────────────┘    └─────────────┘       │
│         │                    │                    │            │
│         └────────────────────┼────────────────────┘            │
│                              ↓                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    PostgreSQL 数据库                      │  │
│  │  - 版本信息表                                             │  │
│  │  - 设备信息表                                             │  │
│  │  - 灰度配置表                                             │  │
│  │  - 更新日志表                                             │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    文件存储系统                           │  │
│  │  /var/www/bundles/                                        │  │
│  │    ├── 1.0.0.450/                                         │  │
│  │    ├── 1.0.0.451/                                         │  │
│  │    └── ...                                                │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS + WebSocket
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                          客户端 (Android)                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    整合层 (4-assembly)                    │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │              HotUpdateManager (核心)               │  │  │
│  │  │  - 版本检查                                         │  │  │
│  │  │  - 下载管理                                         │  │  │
│  │  │  - 安装更新                                         │  │  │
│  │  │  - 回滚机制                                         │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  │                              │                             │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │           HotUpdateTurboModule (桥接)             │  │  │
│  │  │  - JS 调用原生方法                                 │  │  │
│  │  │  - 原生事件通知 JS                                 │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  │                              │                             │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │              ReactInstanceManager                  │  │  │
│  │  │  - 加载 JS Bundle                                  │  │  │
│  │  │  - 重启 React Context                              │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    本地存储                               │  │
│  │  /data/data/com.impos2desktopv1/files/                   │  │
│  │    ├── bundles/                                           │  │
│  │    │   ├── current/                                       │  │
│  │    │   ├── backup/                                        │  │
│  │    │   └── history/                                       │  │
│  │    └── update/                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 核心组件说明

#### 服务端组件

| 组件 | 技术栈 | 职责 |
|------|--------|------|
| Nginx | Nginx 1.24+ | 反向代理、负载均衡、静态文件服务 |
| API 服务 | Node.js + Express | 版本管理、设备管理、灰度配置 |
| 推送服务 | Socket.IO | WebSocket 实时推送更新通知 |
| 数据库 | PostgreSQL 14+ | 持久化存储版本、设备、日志数据 |
| 文件存储 | 本地文件系统 | 存储 Bundle 文件 |

#### 客户端组件

| 组件 | 技术栈 | 职责 |
|------|--------|------|
| HotUpdateManager | Kotlin | 热更新核心逻辑 |
| HotUpdateTurboModule | Kotlin + TurboModule | JS 与原生桥接 |
| ReactInstanceManager | React Native | 加载和重启 JS Bundle |
| 本地存储 | Android File System | 存储 Bundle 文件和版本信息 |

---

## 2. 客户端架构

### 2.1 客户端模块划分

```
4-assembly/android/IMPos2DesktopV1/
└── android/app/src/main/java/com/impos2desktopv1/
    └── hotupdate/
        ├── HotUpdateManager.kt              # 核心管理器
        ├── HotUpdateTurboModule.kt          # TurboModule 桥接
        ├── HotUpdateConfig.kt               # 配置管理
        ├── version/
        │   ├── VersionManager.kt            # 版本管理
        │   └── VersionInfo.kt               # 版本信息模型
        ├── download/
        │   ├── DownloadManager.kt           # 下载管理
        │   └── DownloadTask.kt              # 下载任务
        ├── install/
        │   ├── BundleInstaller.kt           # Bundle 安装器
        │   └── BundleVerifier.kt            # Bundle 校验器
        ├── rollback/
        │   ├── RollbackManager.kt           # 回滚管理
        │   └── TimeoutDetector.kt           # 超时检测
        ├── storage/
        │   ├── BundleStorage.kt             # Bundle 存储
        │   └── MetadataStorage.kt           # 元数据存储
        └── network/
            ├── UpdateApiClient.kt           # API 客户端
            └── PushClient.kt                # 推送客户端
```

### 2.2 核心类设计

#### HotUpdateManager

```kotlin
/**
 * 热更新核心管理器
 * 单例模式，管理整个热更新流程
 */
class HotUpdateManager private constructor(
    private val context: Context
) {
    companion object {
        @Volatile
        private var instance: HotUpdateManager? = null

        fun getInstance(context: Context): HotUpdateManager {
            return instance ?: synchronized(this) {
                instance ?: HotUpdateManager(context).also { instance = it }
            }
        }
    }

    private val versionManager = VersionManager(context)
    private val downloadManager = DownloadManager(context)
    private val bundleInstaller = BundleInstaller(context)
    private val rollbackManager = RollbackManager(context)
    private val apiClient = UpdateApiClient()
    private val pushClient = PushClient()

    /**
     * 初始化热更新模块
     */
    fun initialize() {
        // 1. 加载配置
        // 2. 连接推送服务
        // 3. 注册超时检测
        // 4. 检查是否有待安装的更新
    }

    /**
     * 检查更新
     */
    suspend fun checkUpdate(): UpdateInfo? {
        // 实现检查更新逻辑
    }

    /**
     * 下载更新
     */
    suspend fun downloadUpdate(updateInfo: UpdateInfo): Result<File> {
        // 实现下载逻辑
    }

    /**
     * 安装更新
     */
    suspend fun installUpdate(bundleFile: File): Result<Unit> {
        // 实现安装逻辑
    }

    /**
     * 应用更新（重启应用）
     */
    fun applyUpdate() {
        // 实现应用更新逻辑
    }

    /**
     * 回滚到上一版本
     */
    fun rollback() {
        // 实现回滚逻辑
    }
}
```


#### HotUpdateTurboModule

```kotlin
/**
 * 热更新 TurboModule
 * 提供 JS 调用原生热更新能力的桥接
 */
class HotUpdateTurboModule(
    reactContext: ReactApplicationContext
) : ReactContextBaseJavaModule(reactContext) {

    companion object {
        const val NAME = "HotUpdateModule"
    }

    override fun getName(): String = NAME

    private val hotUpdateManager = HotUpdateManager.getInstance(reactContext)

    /**
     * 检查更新
     */
    @ReactMethod
    fun checkUpdate(promise: Promise) {
        GlobalScope.launch {
            try {
                val updateInfo = hotUpdateManager.checkUpdate()
                if (updateInfo != null) {
                    promise.resolve(updateInfo.toWritableMap())
                } else {
                    promise.resolve(null)
                }
            } catch (e: Exception) {
                promise.reject("CHECK_UPDATE_ERROR", e.message, e)
            }
        }
    }

    /**
     * 下载更新
     */
    @ReactMethod
    fun downloadUpdate(promise: Promise) {
        GlobalScope.launch {
            try {
                val result = hotUpdateManager.downloadUpdate()
                promise.resolve(result.isSuccess)
            } catch (e: Exception) {
                promise.reject("DOWNLOAD_ERROR", e.message, e)
            }
        }
    }

    /**
     * 应用更新（重启应用）
     */
    @ReactMethod
    fun applyUpdate(promise: Promise) {
        try {
            hotUpdateManager.applyUpdate()
            promise.resolve(true)
        } catch (e: Exception) {
            promise.reject("APPLY_UPDATE_ERROR", e.message, e)
        }
    }

    /**
     * 获取当前版本信息
     */
    @ReactMethod
    fun getCurrentVersion(promise: Promise) {
        try {
            val versionInfo = hotUpdateManager.getCurrentVersion()
            promise.resolve(versionInfo.toWritableMap())
        } catch (e: Exception) {
            promise.reject("GET_VERSION_ERROR", e.message, e)
        }
    }

    /**
     * 手动回滚
     */
    @ReactMethod
    fun rollback(promise: Promise) {
        try {
            hotUpdateManager.rollback()
            promise.resolve(true)
        } catch (e: Exception) {
            promise.reject("ROLLBACK_ERROR", e.message, e)
        }
    }

    /**
     * 发送更新事件到 JS
     */
    private fun sendEvent(eventName: String, params: WritableMap?) {
        reactApplicationContext
            .getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter::class.java)
            .emit(eventName, params)
    }
}
```

---

## 3. 服务端架构

### 3.1 服务端模块划分

```
hot-update-server/
├── nginx/
│   ├── nginx.conf                    # Nginx 配置
│   └── ssl/                          # SSL 证书
│       ├── server.crt
│       └── server.key
│
├── api-server/                       # API 服务
│   ├── src/
│   │   ├── controllers/
│   │   │   ├── version.controller.ts
│   │   │   ├── device.controller.ts
│   │   │   └── grayscale.controller.ts
│   │   ├── services/
│   │   │   ├── version.service.ts
│   │   │   ├── bundle.service.ts
│   │   │   └── grayscale.service.ts
│   │   ├── models/
│   │   │   ├── version.model.ts
│   │   │   ├── device.model.ts
│   │   │   └── grayscale.model.ts
│   │   ├── middleware/
│   │   │   ├── auth.middleware.ts
│   │   │   └── error.middleware.ts
│   │   └── app.ts
│   ├── package.json
│   └── tsconfig.json
│
├── push-server/                      # 推送服务
│   ├── src/
│   │   ├── push.server.ts
│   │   ├── connection.manager.ts
│   │   └── message.handler.ts
│   ├── package.json
│   └── tsconfig.json
│
├── database/                         # 数据库
│   ├── migrations/
│   │   ├── 001_create_versions.sql
│   │   ├── 002_create_devices.sql
│   │   └── 003_create_grayscale.sql
│   └── seeds/
│       └── initial_data.sql
│
├── storage/                          # 文件存储
│   └── bundles/
│       ├── 1.0.0.450/
│       ├── 1.0.0.451/
│       └── ...
│
└── admin-panel/                      # 管理后台
    ├── src/
    │   ├── pages/
    │   ├── components/
    │   └── api/
    └── package.json
```

### 3.2 数据库设计

#### 版本信息表 (versions)

```sql
CREATE TABLE versions (
    id SERIAL PRIMARY KEY,
    bundle_version VARCHAR(50) NOT NULL UNIQUE,
    native_version VARCHAR(50) NOT NULL,
    file_path VARCHAR(255) NOT NULL,
    file_size BIGINT NOT NULL,
    md5 VARCHAR(32) NOT NULL,
    signature TEXT NOT NULL,
    description TEXT,
    update_strategy VARCHAR(20) NOT NULL, -- force, auto, prompt
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_bundle_version ON versions(bundle_version);
CREATE INDEX idx_native_version ON versions(native_version);
CREATE INDEX idx_is_active ON versions(is_active);
```

#### 设备信息表 (devices)

```sql
CREATE TABLE devices (
    id SERIAL PRIMARY KEY,
    device_id VARCHAR(100) NOT NULL UNIQUE,
    store_id VARCHAR(100),
    current_bundle_version VARCHAR(50),
    current_native_version VARCHAR(50),
    last_check_time TIMESTAMP,
    last_update_time TIMESTAMP,
    status VARCHAR(20), -- online, offline, updating
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_device_id ON devices(device_id);
CREATE INDEX idx_store_id ON devices(store_id);
CREATE INDEX idx_status ON devices(status);
```

#### 灰度配置表 (grayscale_configs)

```sql
CREATE TABLE grayscale_configs (
    id SERIAL PRIMARY KEY,
    version_id INTEGER REFERENCES versions(id),
    rule_type VARCHAR(20) NOT NULL, -- device_id, store_id, percentage
    rule_value TEXT NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_version_id ON grayscale_configs(version_id);
CREATE INDEX idx_is_active ON grayscale_configs(is_active);
```

#### 更新日志表 (update_logs)

```sql
CREATE TABLE update_logs (
    id SERIAL PRIMARY KEY,
    device_id VARCHAR(100) NOT NULL,
    from_version VARCHAR(50),
    to_version VARCHAR(50) NOT NULL,
    update_strategy VARCHAR(20),
    status VARCHAR(20) NOT NULL, -- success, failed, rollback
    error_message TEXT,
    duration_ms INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_device_id ON update_logs(device_id);
CREATE INDEX idx_status ON update_logs(status);
CREATE INDEX idx_created_at ON update_logs(created_at);
```

