# IMPos2 企业级终端热更新系统设计文档

## 文档信息

- **项目名称**: IMPos2 Enterprise POS System
- **文档版本**: v1.0.0
- **创建日期**: 2026-02-05
- **适用范围**: 整合层 (4-assembly/android/IMPos2DesktopV1)
- **技术栈**: React Native 0.76.6 + Android + Monorepo

---

## 文档目录

1. [热更新原理与机制](./02-热更新原理与机制.md)
2. [系统架构设计](./03-系统架构设计.md)
3. [更新包管理](./04-更新包管理.md)
4. [客户端实现方案](./05-客户端实现方案.md)
5. [服务端实现方案](./06-服务端实现方案.md)
6. [常见问题与解决方案](./07-常见问题与解决方案.md)

---

## 系统概述

### 设计目标

为 IMPos2 企业级终端系统设计一套完整的热更新解决方案，实现：

1. **JS Bundle 热更新**：无需重新安装 APK，动态更新业务逻辑
2. **版本独立管理**：原生版本和 JS Bundle 版本分离
3. **灰度发布**：支持按设备 ID、门店 ID 分批更新
4. **多级更新策略**：强制静默更新、自动静默更新、提示更新
5. **服务器推送**：通过 WebSocket 实时推送更新通知
6. **自动回滚**：更新失败或超时自动回滚到上一版本
7. **双屏支持**：主副屏使用同一 Bundle，重启逻辑复用现有机制

### 核心特性

- ✅ **零停机更新**：后台下载，用户无感知
- ✅ **安全可靠**：签名验证、完整性校验、自动回滚
- ✅ **灰度发布**：支持分批次、分设备组更新
- ✅ **版本管理**：保留 10 个历史版本，支持快速回滚
- ✅ **全量更新**：简单可靠，包大小几兆，适合互联网环境
- ✅ **超时保护**：30 秒未完成初始化自动回滚

### 技术选型

#### 客户端
- **热更新引擎**: 自研（基于 React Native 原生能力）
- **存储**: Android 内部存储 + SharedPreferences
- **网络**: OkHttp3 + WebSocket
- **签名验证**: SHA-256 + RSA

#### 服务端
- **Web 服务器**: Nginx
- **应用服务器**: Node.js + Express
- **数据库**: PostgreSQL
- **文件存储**: 本地文件系统
- **推送服务**: Socket.IO

---

## 快速导航

### 如果你想了解...

- **热更新的工作原理** → 查看 [02-热更新原理与机制](./02-热更新原理与机制.md)
- **整体架构设计** → 查看 [03-系统架构设计](./03-系统架构设计.md)
- **如何打包和管理更新包** → 查看 [04-更新包管理](./04-更新包管理.md)
- **客户端如何实现** → 查看 [05-客户端实现方案](./05-客户端实现方案.md)
- **服务端如何搭建** → 查看 [06-服务端实现方案](./06-服务端实现方案.md)
- **常见问题和解决方案** → 查看 [07-常见问题与解决方案](./07-常见问题与解决方案.md)

---

## 业界参考案例

本方案参考了以下成熟的热更新解决方案：

1. **Microsoft CodePush**
   - 优点：成熟稳定、功能完善
   - 缺点：依赖微软云服务
   - 借鉴：版本管理、回滚机制、灰度发布

2. **React Native Hot Update (pushy.reactnative.cn)**
   - 优点：国内方案、支持私有部署
   - 缺点：需要付费
   - 借鉴：更新流程、差分算法

3. **AppCenter CodePush**
   - 优点：集成度高、易用性好
   - 缺点：依赖云服务
   - 借鉴：更新策略、用户体验

### 我们的方案优势

- ✅ **完全自主可控**：服务器完全自建，无第三方依赖
- ✅ **深度定制**：针对 Monorepo 架构优化
- ✅ **双屏支持**：原生支持主副屏场景
- ✅ **企业级**：灰度发布、版本管理、监控告警

---

## 版本历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0.0 | 2026-02-05 | Claude | 初始版本 |

